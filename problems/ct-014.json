{
  "id": "ct-014",
  "title": "操作ログからユーザーシナリオを再構築せよ",
  "difficulty": "hard",
  "category": [
    "array",
    "grouping",
    "state-management"
  ],
  "time_limit_sec": 2.0,
  "memory_limit_mb": 512,
  "description": "# 操作ログからユーザーシナリオを再構築せよ\n\n## 問題概要\n\nブラウザ操作ログから、ユーザーが実行した画面遷移シナリオを再構築してください。\n\nログは `sessionId` ごとにグループ化され、`navigate` アクションが画面遷移を表します。各 `navigate` アクションから次の `navigate` アクションまで（またはログの終わりまで）を1つのシナリオとします。各シナリオの開始ページとアクション数を算出してください。\n\n## 入力仕様\n\n- `logs`: アクションログのリスト。各ログは以下のプロパティを持つ\n  - `sessionId`: セッションID（文字列）\n  - `timestamp`: タイムスタンプ（ミリ秒、整数）\n  - `action`: アクションタイプ（\"click\"、\"input\"、\"navigate\" のいずれか）\n  - `target`: アクションの対象（文字列、navigateの場合は遷移先ページ）\n\n## 出力仕様\n\n- `list[dict]`: セッションごとのシナリオサマリーのリスト。各要素は以下のプロパティを持つ\n  - `sessionId`: セッションID\n  - `scenarios`: シナリオのリスト。各シナリオは以下のプロパティを持つ\n    - `startPage`: シナリオの開始ページ（navigateのtarget）\n    - `actionCount`: そのシナリオ内のアクション数（navigateを含む）\n\n## 制約条件\n\n- `0 <= len(logs) <= 10^5`\n- ログはタイムスタンプの昇順でソートされている\n- `0 <= timestamp <= 10^9`\n- 複数の `sessionId` が混在する可能性がある\n- `navigate` アクションが来る前に他のアクションが存在する場合、最初の `navigate` までを1つのシナリオとする\n\n## サンプル入力・出力\n\n### サンプル1\n\n入力:\n```typescript\nlogs = [\n  { sessionId: \"s1\", timestamp: 100, action: \"navigate\", target: \"/home\" },\n  { sessionId: \"s1\", timestamp: 200, action: \"click\", target: \"button\" },\n  { sessionId: \"s1\", timestamp: 300, action: \"navigate\", target: \"/about\" },\n  { sessionId: \"s1\", timestamp: 400, action: \"input\", target: \"form\" }\n]\n```\n\n出力:\n```typescript\n[\n  {\n    sessionId: \"s1\",\n    scenarios: [\n      { startPage: \"/home\", actionCount: 2 },\n      { startPage: \"/about\", actionCount: 2 }\n    ]\n  }\n]\n```\n\n### サンプル2（複数セッション）\n\n入力:\n```typescript\nlogs = [\n  { sessionId: \"s1\", timestamp: 100, action: \"navigate\", target: \"/page1\" },\n  { sessionId: \"s2\", timestamp: 200, action: \"navigate\", target: \"/page2\" },\n  { sessionId: \"s1\", timestamp: 300, action: \"click\", target: \"btn\" }\n]\n```\n\n出力:\n```typescript\n[\n  {\n    sessionId: \"s1\",\n    scenarios: [\n      { startPage: \"/page1\", actionCount: 2 }\n    ]\n  },\n  {\n    sessionId: \"s2\",\n    scenarios: [\n      { startPage: \"/page2\", actionCount: 1 }\n    ]\n  }\n]\n```\n\n### サンプル3（navigate前のアクション）\n\n入力:\n```typescript\nlogs = [\n  { sessionId: \"s1\", timestamp: 100, action: \"click\", target: \"button\" },\n  { sessionId: \"s1\", timestamp: 200, action: \"navigate\", target: \"/home\" },\n  { sessionId: \"s1\", timestamp: 300, action: \"input\", target: \"form\" }\n]\n```\n\n出力:\n```typescript\n[\n  {\n    sessionId: \"s1\",\n    scenarios: [\n      { startPage: \"/home\", actionCount: 2 }\n    ]\n  }\n]\n```",
  "function_signature": "def solve(logs: list[dict]) -> list[dict]:",
  "test_code": "def test_sample1():\n    logs = [\n        {\"sessionId\": \"s1\", \"timestamp\": 100, \"action\": \"navigate\", \"target\": \"/home\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 200, \"action\": \"click\", \"target\": \"button\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 300, \"action\": \"navigate\", \"target\": \"/about\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 400, \"action\": \"input\", \"target\": \"form\"}\n    ]\n    result = solve(logs)\n    assert len(result) == 1\n    assert result[0][\"sessionId\"] == \"s1\"\n    assert len(result[0][\"scenarios\"]) == 2\n    assert result[0][\"scenarios\"][0][\"startPage\"] == \"/home\"\n    assert result[0][\"scenarios\"][0][\"actionCount\"] == 2\n    assert result[0][\"scenarios\"][1][\"startPage\"] == \"/about\"\n    assert result[0][\"scenarios\"][1][\"actionCount\"] == 2\n\ndef test_sample2():\n    logs = [\n        {\"sessionId\": \"s1\", \"timestamp\": 100, \"action\": \"navigate\", \"target\": \"/page1\"},\n        {\"sessionId\": \"s2\", \"timestamp\": 200, \"action\": \"navigate\", \"target\": \"/page2\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 300, \"action\": \"click\", \"target\": \"btn\"}\n    ]\n    result = solve(logs)\n    assert len(result) == 2\n    s1 = next(r for r in result if r[\"sessionId\"] == \"s1\")\n    s2 = next(r for r in result if r[\"sessionId\"] == \"s2\")\n    assert len(s1[\"scenarios\"]) == 1\n    assert s1[\"scenarios\"][0][\"startPage\"] == \"/page1\"\n    assert s1[\"scenarios\"][0][\"actionCount\"] == 2\n    assert len(s2[\"scenarios\"]) == 1\n    assert s2[\"scenarios\"][0][\"startPage\"] == \"/page2\"\n    assert s2[\"scenarios\"][0][\"actionCount\"] == 1\n\ndef test_sample3():\n    logs = [\n        {\"sessionId\": \"s1\", \"timestamp\": 100, \"action\": \"click\", \"target\": \"button\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 200, \"action\": \"navigate\", \"target\": \"/home\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 300, \"action\": \"input\", \"target\": \"form\"}\n    ]\n    result = solve(logs)\n    assert len(result) == 1\n    assert len(result[0][\"scenarios\"]) == 1\n    assert result[0][\"scenarios\"][0][\"startPage\"] == \"/home\"\n    assert result[0][\"scenarios\"][0][\"actionCount\"] == 2\n\ndef test_single_navigate():\n    logs = [\n        {\"sessionId\": \"s1\", \"timestamp\": 100, \"action\": \"navigate\", \"target\": \"/page\"}\n    ]\n    result = solve(logs)\n    assert len(result) == 1\n    assert len(result[0][\"scenarios\"]) == 1\n    assert result[0][\"scenarios\"][0][\"startPage\"] == \"/page\"\n    assert result[0][\"scenarios\"][0][\"actionCount\"] == 1\n\ndef test_no_navigate():\n    logs = [\n        {\"sessionId\": \"s1\", \"timestamp\": 100, \"action\": \"click\", \"target\": \"btn\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 200, \"action\": \"input\", \"target\": \"form\"}\n    ]\n    result = solve(logs)\n    # navigateがない場合、シナリオは作成されない（または空のシナリオ）\n    assert len(result) == 1\n    assert len(result[0][\"scenarios\"]) == 0\n\ndef test_multiple_navigates_same_session():\n    logs = [\n        {\"sessionId\": \"s1\", \"timestamp\": 100, \"action\": \"navigate\", \"target\": \"/page1\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 200, \"action\": \"navigate\", \"target\": \"/page2\"},\n        {\"sessionId\": \"s1\", \"timestamp\": 300, \"action\": \"navigate\", \"target\": \"/page3\"}\n    ]\n    result = solve(logs)\n    assert len(result) == 1\n    assert len(result[0][\"scenarios\"]) == 3\n    assert result[0][\"scenarios\"][0][\"startPage\"] == \"/page1\"\n    assert result[0][\"scenarios\"][0][\"actionCount\"] == 1\n    assert result[0][\"scenarios\"][1][\"startPage\"] == \"/page2\"\n    assert result[0][\"scenarios\"][1][\"actionCount\"] == 1\n    assert result[0][\"scenarios\"][2][\"startPage\"] == \"/page3\"\n    assert result[0][\"scenarios\"][2][\"actionCount\"] == 1",
  "supported_languages": [
    "python",
    "typescript"
  ],
  "hint": "## ヒント\n\nこの問題は**ログのグループ化と状態管理**が鍵となります。\n\n### 重要なポイント\n\n1. **セッションごとのグループ化**: `sessionId` でログを分類\n2. **シナリオの分割**: `navigate` アクションを区切りとしてシナリオを分割\n3. **状態管理**: 現在のシナリオの開始ページとアクション数を追跡\n\n### 解法の流れ\n\n1. `sessionId` ごとにログをグループ化（辞書を使用）\n2. 各セッションのログを順番に処理\n3. `navigate` アクションが来たら：\n   - 前のシナリオがあれば保存（開始ページとアクション数）\n   - 新しいシナリオを開始（開始ページ = navigate の target）\n4. `navigate` 以外のアクションは現在のシナリオに追加\n5. 最後のシナリオも忘れずに保存\n\n### 注意点\n\n- `navigate` が来る前に他のアクションがある場合、最初の `navigate` までを1つのシナリオとする（または無視）\n- `navigate` が1つもないセッションの場合、シナリオは空リスト\n- 各シナリオの `actionCount` には `navigate` 自体も含める",
  "solution": "## 答えと解説\n\n### 解法\n\n```python\ndef solve(logs: list[dict]) -> list[dict]:\n    # セッションごとにログをグループ化\n    sessions = {}\n    for log in logs:\n        session_id = log[\"sessionId\"]\n        if session_id not in sessions:\n            sessions[session_id] = []\n        sessions[session_id].append(log)\n    \n    result = []\n    \n    # 各セッションを処理\n    for session_id, session_logs in sessions.items():\n        scenarios = []\n        current_scenario = None\n        \n        for log in session_logs:\n            action = log[\"action\"]\n            \n            if action == \"navigate\":\n                # 前のシナリオを保存\n                if current_scenario is not None:\n                    scenarios.append(current_scenario)\n                \n                # 新しいシナリオを開始\n                current_scenario = {\n                    \"startPage\": log[\"target\"],\n                    \"actionCount\": 1  # navigate 自体を含む\n                }\n            else:\n                # navigate 以外のアクション\n                if current_scenario is not None:\n                    # 既にシナリオが開始されている場合\n                    current_scenario[\"actionCount\"] += 1\n                # navigate がまだ来ていない場合は無視（または最初の navigate までを1つのシナリオとする）\n        \n        # 最後のシナリオを保存\n        if current_scenario is not None:\n            scenarios.append(current_scenario)\n        \n        result.append({\n            \"sessionId\": session_id,\n            \"scenarios\": scenarios\n        })\n    \n    return result\n```\n\n```typescript\nexport function solve(logs: list[dict]) -> list[dict]:\n    # セッションごとにログをグループ化\n    sessions = {}\n    for (const log of logs) {\n        session_id = log[\"sessionId\"]\n        if session_id sessions.has(not):\n            sessions[session_id] = []\n        sessions[session_id].append(log)\n    \n    result = []\n    \n    # 各セッションを処理\n    for session_id, session_logs in sessions.items():\n        scenarios = []\n        current_scenario = null\n        \n        for (const log of session_logs) {\n            action = log[\"action\"]\n            \n            if action == \"navigate\":\n                # 前のシナリオを保存\n                if current_scenario is not null:\n                    scenarios.append(current_scenario)\n                \n                # 新しいシナリオを開始\n                current_scenario = {\n                    \"startPage\": log[\"target\"],\n                    \"actionCount\": 1  # navigate 自体を含む\n                }\n            else:\n                # navigate 以外のアクション\n                if current_scenario is not null:\n                    # 既にシナリオが開始されている場合\n                    current_scenario[\"actionCount\"] += 1\n                # navigate がまだ来ていない場合は無視（または最初の navigate までを1つのシナリオとする）\n        \n        # 最後のシナリオを保存\n        if current_scenario is not null:\n            scenarios.append(current_scenario)\n        \n        result.append({\n            \"sessionId\": session_id,\n            \"scenarios\": scenarios\n        })\n    \n    return result\n```\n\n### 解説\n\n1. **グループ化**: `sessionId` をキーとしてログをグループ化\n2. **シナリオの追跡**: 現在のシナリオの状態（開始ページ、アクション数）を保持\n3. **navigate の処理**: \n   - `navigate` が来たら前のシナリオを保存し、新しいシナリオを開始\n   - `navigate` の `target` が開始ページとなる\n4. **アクション数のカウント**: 各シナリオ内のアクション（`navigate` を含む）をカウント\n\n### 具体例\n\n```python\nlogs = [\n    {\"sessionId\": \"s1\", \"action\": \"navigate\", \"target\": \"/home\"},\n    {\"sessionId\": \"s1\", \"action\": \"click\", \"target\": \"button\"},\n    {\"sessionId\": \"s1\", \"action\": \"navigate\", \"target\": \"/about\"},\n    {\"sessionId\": \"s1\", \"action\": \"input\", \"target\": \"form\"}\n]\n```\n\n```typescript\nlogs = [\n    {\"sessionId\": \"s1\", \"action\": \"navigate\", \"target\": \"/home\"},\n    {\"sessionId\": \"s1\", \"action\": \"click\", \"target\": \"button\"},\n    {\"sessionId\": \"s1\", \"action\": \"navigate\", \"target\": \"/about\"},\n    {\"sessionId\": \"s1\", \"action\": \"input\", \"target\": \"form\"}\n]\n```\n\n処理の流れ：\n1. `/home` で navigate → シナリオ1開始（actionCount=1）\n2. click → シナリオ1に追加（actionCount=2）\n3. `/about` で navigate → シナリオ1を保存、シナリオ2開始（actionCount=1）\n4. input → シナリオ2に追加（actionCount=2）\n5. シナリオ2を保存\n\n結果：`[{\"sessionId\": \"s1\", \"scenarios\": [{\"startPage\": \"/home\", \"actionCount\": 2}, {\"startPage\": \"/about\", \"actionCount\": 2}]}]`\n\n### 時間計算量\n\n- **時間計算量**: O(n) ここで n はログ数\n- **空間計算量**: O(n) セッションごとのグループ化とシナリオの保存"
}